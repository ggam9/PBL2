{% extends "group_page.html" %} 

{% block title %}Take Quiz{% endblock %}

{% block content %}
<style>
    .quiz-wrapper {
        display: flex;
        gap: 40px;
        margin: 40px;
    }

    .quiz-main {
        flex: 2;
    }

    .quiz-side {
        flex: 1;
        border-left: 2px solid #eee;
        padding-left: 20px;
    }

    .btn {
        margin-top: 15px;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
        margin-top: 60px;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        margin-top: 30px;
    }

    .quiz-image {
        max-width: 100%;
        height: auto;
        margin: 20px 0;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 15px;
    }
    
    .disabled {
        pointer-events: none;
        opacity: 0.6;
    }
    .form-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
    }

    .feedback-box {
        font-size: 16px;
        font-weight: 500;
        min-height: 1.5em;
    }

    .feedback-box.correct {
        color: green;
    }

    .feedback-box.incorrect {
        color: red;
    }
    
</style>

<div class="quiz-wrapper">
    <!-- Main Quiz Section -->
    <div class="quiz-main">
        <h2>Quiz</h2>
        <p><strong>Question:</strong> {{ quiz.question }}</p>

        {% if quiz.image %}
        <img src="{{ url_for('static', filename='uploads/' + quiz.image) }}" alt="Quiz Image" class="quiz-image">
        {% endif %}

        <form id="quiz-form" class="quiz-form">
          <div class="form-group">
            <label for="answer">Your Answer</label>
            <input type="text" id="answer" name="answer" class="form-control" required>
          </div>
          <div class="form-row">
           <button type="submit" class="btn btn-primary">Check Answer</button>
           <div id="feedback" class="feedback-box"></div>
          </div>
        </form>

        {% if next_quiz %}
         <a href="{{ url_for('take_quiz', post_id=quiz.post_id, quiz_id=next_quiz.id) }}" class="btn btn-secondary">Next Quiz</a>
        {% else %}
         <div style="display: flex; align-items: center; gap: 20px; margin-top: 30px;">
         <p style="margin: 0;">You have completed all the quizzes!</p>
         <a href="{{ url_for('group_page', post_id=quiz.post_id) }}" class="btn btn-success">Back to Group</a>
         </div>
        {% endif %}
    </div>

    
</div>

<script>
let attemptsRemaining = 3;
let answeredCorrectly = false;

document.getElementById('quiz-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const answerInput = document.getElementById('answer');
    const answer = answerInput.value.trim();
    const feedback = document.getElementById('feedback');
    const attemptInfo = document.getElementById('attempt-info');

    if (answeredCorrectly) {
        feedback.textContent = "You've already answered correctly.";
        feedback.style.color = 'green';
        return;
    }

    fetch('{{ url_for("check_answer", post_id=quiz.post_id, quiz_id=quiz.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answer: answer }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.correct) {
            feedback.textContent = '‚úÖ Correct!';
            feedback.style.color = 'green';
            answeredCorrectly = true;
        } else {
            if (attemptsRemaining > 0) {
                attemptsRemaining--;
            }

            if (attemptsRemaining > 0) {
                feedback.textContent = `‚ùå Incorrect. Try again.`;
                feedback.style.color = 'red';
                attemptInfo.textContent = `üß† Attempts Remaining: ${attemptsRemaining}`;
            } else {
                feedback.innerHTML = `‚ùå Incorrect. <br>‚úÖ The correct answer is: <strong>${data.correct_answer}</strong>`;
                feedback.style.color = 'red';
                attemptInfo.textContent = `üß† Attempts Remaining: 0`;
            }
        }
    })
    .catch(error => console.error('Error:', error));
});
</script>
{% endblock %}
